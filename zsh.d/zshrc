# alias
if [ -f ~/.zsh_aliases ]; then
    source ~/.zsh_aliases
fi

# 個別設定ファイルがあれば読み込む
if [ -f ~/.zshrc_local ]; then
  source ~/.zshrc_local
fi

# History
HISTFILE=~/.zsh_history
HISTSIZE=50000
SAVEHIST=50000
HISTIGNORE='history:pwd:ls:ll:exit'
setopt INC_APPEND_HISTORY      # 履歴を追記
setopt SHARE_HISTORY           # 複数シェルで履歴共有

# starship
export STARSHIP_CONFIG="$HOME/.config/starship.toml"

# viモード（zle）
bindkey -v
# jjでInsert→Normal
bindkey -M viins 'jj' vi-cmd-mode

# Starship 初期化（多重初期化ガード）
if [[ -z ${STARSHIP_INIT_DONE-} ]]; then
  eval "$(starship init zsh)"
  typeset -g STARSHIP_INIT_DONE=1
fi

# --- カーソル形状をモードで出し分け（※ Starshipの関数は上書きしない）---
autoload -Uz add-zle-hook-widget
function _cursor_by_keymap {
  case $KEYMAP in
    vicmd)      printf '\e[1 q' ;;  # Normal: ブロック
    viins|main) printf '\e[5 q' ;;  # Insert: ビーム
  esac
}
add-zle-hook-widget zle-keymap-select _cursor_by_keymap
add-zle-hook-widget zle-line-init _cursor_by_keymap
# 起動直後のカーソル（Insert想定）
printf '\e[5 q'

# --- 補助: Homebrew の starship を優先（任意）---
# eval "$(/opt/homebrew/bin/brew shellenv)"  # 必要なら

# zoxide
eval "$(zoxide init zsh)"

# brew path
export PATH="/opt/homebrew/bin:$PATH"
export PATH="/opt/homebrew/sbin:$PATH"

# pyenv
export PATH="$HOME/.pyenv/bin:$PATH"
if command -v pyenv 1>/dev/null 2>&1; then
  eval "$(pyenv init --path)"
  eval "$(pyenv init -)"
fi

# myFunction
fcp() {
  if [[ -f "$1" ]]; then
    cat "$1" | pbcopy
    echo "Copied: $1"
  else
    echo "File not found: $1" >&2
  fi
}

# ==========================
# calc(): 軽量 IPython 起動
# - venv を（サブシェル内で）activate
# - IPython 終了時に deactivate
# - 呼び出し元シェルの環境は汚さない
# ==========================

calc() {
  local VENV="${CALC_VENV:-$HOME/.venvs/calc}"
  # オプションは配列にしておく
  local -a IPY_OPTS=(--quick --no-banner --HistoryManager.enabled=False)

  if [[ ! -x "$VENV/bin/ipython" ]]; then
    echo "calc: $VENV/bin/ipython が見つかりません。まず install.sh を実行してください。" >&2
    return 1
  fi

  (
    source "$VENV/bin/activate"
    export VIRTUAL_ENV_DISABLE_PROMPT=1

    # 配列を展開して実行
    ipython "${IPY_OPTS[@]}"

    type deactivate >/dev/null 2>&1 && deactivate
  )
}
